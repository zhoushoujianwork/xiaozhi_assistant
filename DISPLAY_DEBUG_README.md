# LCD显示调试功能说明

## 问题分析

根据代码分析，LCD显示摄像头画面可能不显示的原因包括：

1. **双线程V4L2-DRM冲突**：AI线程和显示线程都使用V4L2-DRM，但配置不同
2. **缓冲区管理问题**：`context.display = false` 在AI线程中可能影响显示
3. **显示状态机问题**：`display_state` 可能影响画面显示
4. **摄像头数据流问题**：摄像头数据可能无效或中断

## 添加的调试功能

### 1. AI线程调试日志
- **摄像头初始化日志**：显示设备参数、分辨率、格式等
- **帧处理日志**：每30帧显示处理进度和缓冲区索引
- **数据有效性检查**：每60帧检查摄像头数据是否有效（非全零）

### 2. 显示线程调试日志
- **显示初始化日志**：显示分辨率、旋转模式、V4L2-DRM设置状态
- **缓冲区分配日志**：显示plane ID、缓冲区尺寸和大小
- **显示循环启动日志**：确认v4l2_drm_run启动状态

### 3. 帧处理调试日志
- **帧到达日志**：每30帧显示处理状态
- **显示状态监控**：实时监控display_state变化
- **绘制过程日志**：显示人脸检测数量、绘制状态
- **缓冲区同步日志**：显示图像复制和更新状态

### 4. 系统诊断功能
- **定期诊断**：每10秒自动进行系统状态检查
- **手动诊断**：通过命令99触发详细诊断
- **状态监控**：监控显示对象、缓冲区、线程状态等

## 使用方法

### 查看调试输出
运行程序后，控制台会显示详细的调试信息：

```
[AI_THREAD] 初始化摄像头参数: device=1, size=1920x1080, format=BGR_PLANAR, buffers=3
[AI_THREAD] v4l2_drm_setup 成功
[AI_THREAD] v4l2_drm_start 成功，开始摄像头数据流
[DISPLAY_THREAD] 开始初始化显示线程，device=2
[DISPLAY_THREAD] 显示分辨率: 800x480
[DISPLAY_THREAD] 横屏模式: 800x480, rotation=0
[FRAME_HANDLER] 第一帧到达，解锁AI线程
[FRAME_HANDLER] 显示第 30 帧
[FRAME_HANDLER] 新帧数据，开始绘制，buffer_hold=0
[FRAME_HANDLER] 横屏模式，显示状态=1
[FRAME_HANDLER] 绘制人脸识别结果，检测到 0 个人脸
[FRAME_HANDLER] 复制图像到显示缓冲区，size=1536000
[FRAME_HANDLER] 显示缓冲区更新完成
```

### 手动诊断
通过消息队列发送命令99可以触发详细诊断：

```cpp
// 在UI或其他地方调用
ai_cmd_message_t msg;
msg.cmd = 99;
mq->SendAIMsg(&msg);
```

### 定期诊断
程序每10秒会自动输出系统状态：

```
[MAIN] 定期系统诊断 (运行时间: 10秒)
======== 显示系统诊断 ========
✓ 显示对象已初始化
  - 分辨率: 800x480
  - 文件描述符: 3
  - 连接器ID: 0
  - CRTC ID: 0
✓ 绘制缓冲区已分配
  - 尺寸: 800x480
  - 大小: 1536000 字节
  - 内存映射: 有效
当前状态:
  - AI状态: 1
  - 显示状态: 1
  - 语音唤醒状态: 1
  - 显示状态变化次数: 0
线程状态:
  - 视频停止标志: 否
  - 音频停止标志: 否
  - 显示停止标志: 否
============================
```

## 常见问题诊断

### 1. 摄像头数据无效
如果看到以下日志：
```
[AI_THREAD] 警告：摄像头数据可能无效（全零数据）
```
说明摄像头没有正常提供数据，需要检查：
- 摄像头设备是否正常连接
- 摄像头驱动是否正常加载
- V4L2设备权限是否正确

### 2. 显示缓冲区问题
如果看到以下日志：
```
[DISPLAY_THREAD] display_get_plane 失败
[DISPLAY_THREAD] display_allocate_buffer 失败
```
说明显示系统初始化失败，需要检查：
- DRM设备是否可用
- 显示权限是否正确
- 内存是否充足

### 3. 帧处理问题
如果看到以下日志：
```
[FRAME_HANDLER] 无可用显示缓冲区，buffer_hold=-1
```
说明显示缓冲区管理有问题，需要检查：
- V4L2-DRM设置是否正确
- 缓冲区分配是否成功
- 显示循环是否正常启动

## 建议的修复方案

1. **统一V4L2-DRM配置**：确保AI线程和显示线程使用兼容的配置
2. **优化缓冲区管理**：改进缓冲区分配和释放逻辑
3. **增强错误处理**：在关键点添加错误检查和恢复机制
4. **性能优化**：减少不必要的调试输出以提高性能

## 注意事项

- 调试日志会增加系统开销，生产环境建议减少日志频率
- 定期诊断功能会每10秒输出一次，可能影响性能
- 建议在问题解决后适当减少调试输出
